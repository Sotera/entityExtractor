extends /modules/core/views/layouts/layout
block content
  .row
    .col-md-1
    .col-md-10
      .row
        .col-md-12
          h3 Threat Detection
      .row
        .col-md-12
          form#archive-form
            .form-group
              label URL to zip file
              input#archive-url.form-control(name='images_url' placeholder='https://s3.amazonaws.com/bucket/images.zip' value='https://s3.amazonaws.com/watchman/threat-detection-test.zip')
            .form-group
              label.radio-inline
                input(type='radio' value='day' name='tod' checked)
                | Day
              label.radio-inline
                input(type='radio' value='night' name='tod')
                | Night
            .form-group
              button.btn.btn-primary(type='submit') Run Detection
      .row#images-container(style='margin-top:20px')

    .col-md-1

block scripts
  script.
    var $body = $('body')
    var spinner = new Spinner({scale: 3, lines: 10})

    $('#archive-form').submit(function(e) {
      e.preventDefault()
      spinner.spin($body[0])
      $.post('/api/extract/threats', {
        archive_url: $('#archive-url').val(),
        time_of_day: $('input[name="tod"]:checked').val()
      })
      .success(function(data) {
        console.log(data)
        checkJob(data)
      })
    })

    function checkJob(id) {
      $.post('/api/jobs/status', { job_id: id })
      .success(function(data) {
        console.log(data)
        if (data.state === 'processed') {
          spinner.stop()
          showImages(JSON.parse(data.data))
        } else {
          setTimeout(function() { checkJob(id) }, 2000)
        }
      })
    }

    function showImages(images) {
      console.log(images)
      var $imgContainer = $('#images-container')
      $imgContainer.empty()

      images.forEach(function(img) {
        var src = img.name.replace(/\/downloads/i, '')
        var level = img.classification === 'threat' ? 'bg-danger' : 'bg-success'
        var div = $('<div class="col-md-2" style="height:200px" onclick="window.open(\'' + src + '\')"><p class="' + level + '">' + img.classification + '</p><img width="100%" src="'
          + src + '"></div>')
        $imgContainer.append(div)
      })
    }
